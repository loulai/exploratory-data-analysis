---
title: "Traffic Exploration"
author: "Louise Lai"
date: "August 4, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(magrittr)
library(forcats)
library(ggplot2)
library(scales)
```



```{r}
setwd("~/Desktop/programming/eda/homework/hw3")
original <- as.data.frame(read.csv("./Officer_Traffic_Stops.csv", na.strings = c("", " ", "  ", "NA"))) 
df <-  original

##### Data Cleaning

returnCleanData <- function(){
  
  # count NAs
  anyNA(df) # TRUE
  colnames(df)[apply(df, 2, anyNA)] # returns colnames that have NAs 
  
  ## NAs
  df$Officer_Race <- as.character(df$Officer_Race)
  df %<>% mutate(Officer_Race = replace(Officer_Race, is.na(Officer_Race), "Missing")) # replace
  df$Officer_Race <- as.factor(df$Officer_Race)
  
  # unsure what to do with CMPD_Division NAs yet!
  
  ## Dates
  df$Month_of_Stop <- parse_date(df$Month_of_Stop, "%Y/%m")
  
  ## Logicals
  levels(df$Was_a_Search_Conducted)
  levels(df$Was_a_Search_Conducted) <- c(FALSE, TRUE) # set 'No' to FALSE, 'Yes' to TRUE
  df$Was_a_Search_Conducted <- as.logical(df$Was_a_Search_Conducted)
  
  ## Order Factors
  levels(df$Result_of_Stop) # come back~ <<
  
  # Change White/Hispanic 
  df %>% 
    filter(Driver_Race == "White" & Driver_Ethnicity == "Hispanic") %>% 
    nrow() # There are 6,623 drivers that are White and Hispanic 
  
  df %>% 
    filter(Driver_Race == "White" & Driver_Ethnicity == "Hispanic") %>% 
    nrow() # There are 6,623 drivers that are White and Hispanic 
  
  df$Driver_Race <- as.character(df$Driver_Race)
  df %<>%
    mutate(Driver_Race = replace(Driver_Race, !Driver_Race == "White" & Driver_Ethnicity == "Hispanic", "White Hispanic")) # replace White (race) && Hispanic (ethnicity) to just 'White Hispanic' (race)
  
  # Filter truly unnecessary columns
  df %<>% 
    select(-13, -14, -15, -16, -17)
  
  return(df)
}

df <- returnCleanData()

```

```{r}
# Data Exploration
glimpse(df) # 79884 observations, 12 variables

# How many officers, by race
df %>% 
  count(Officer_Race) %>% 
  arrange(desc(n)) %>% 
  View()

df %>% 
  mutate(Officer_Race = Officer_Race %>% fct_infreq()) %>% 
  ggplot(aes(Officer_Race)) +
  geom_bar() +
  xlab("Race of the Officer") +
  ylab("Number of Officers") +
  labs(title="Count of Officers by Race") +
  scale_y_continuous(breaks=seq(0, 60000, 10000), labels=comma_format()) +
  theme_classic() +
  theme(
    axis.text.x=element_text(angle=60, hjust=1),
    panel.background = element_rect(fill="lightblue"),
    panel.grid.minor = element_line(size=0.25, linetype='solid',
                                    color='white'),
    text=element_text(family="Helvetica"))

# How many drivers stopped, by race
df %>% 
  count(Driver_Race) %>% 
  arrange(desc(n)) %>% 
  View()

df %>% 
  mutate(Driver_Race = Driver_Race %>% fct_infreq()) %>% 
  ggplot(aes(Driver_Race)) +
  geom_bar() +
  xlab("Race of the Driver") +
  ylab("Number of Drivers") +
  labs(title="Count of Drivers by Race") +
  scale_y_continuous(breaks=seq(0, 50000, 10000), labels=comma_format()) +
  theme_classic() +
  theme(
    axis.text.x=element_text(angle=60, hjust=1),
    panel.background = element_rect(fill="lightblue"),
    panel.grid.minor = element_line(size=0.25, linetype='solid',
                                    color='white'),
    text=element_text(family="Helvetica"))

# we see that it's mostly white officers, by a large amount. Come back and see percentages.
```

```{r}
# Given that some legal action resulted, how many of those arrested are of each ethnicity?

# first, let's explore. How many legal actions were taken?
totalStops <- nrow(df) # 79,884
totalLegalActions <- df %>% filter(Result_of_Stop == "Citation Issued" | Result_of_Stop == "Arrest") %>% nrow() # 34,506
totalLegalActions/totalStops # 43% of stops result in a legal action

legalActiondf <- df %>% filter(Result_of_Stop == "Citation Issued" | Result_of_Stop == "Arrest")

df2 <- legalActiondf %>% 
  group_by(Driver_Race) %>% 
  summarize(ethnicityArrestedPercent = 100 * n()/totalLegalActions) %>% 
  arrange(desc(ethnicityArrestedPercent)) # black = 53%, White 42%

View(df2)

pie <- df2 %>% 
  mutate(ethnicityArrestedPercent = ethnicityArrestedPercent) %>% 
  ggplot(aes(x="", y=ethnicityArrestedPercent, fill=Driver_Race)) +
  geom_bar(width=1, stat="identity") + 
  coord_polar("y", start=0) +
  labs(title="Given arrested, what is their ethnicity?", xlab="", ylab="") +
  geom_text(aes(y = ethnicityArrestedPercent/5 + c(0, cumsum(ethnicityArrestedPercent)[-length(ethnicityArrestedPercent)]), 
            label = percent(ethnicityArrestedPercent/100)), size=3)+ 
  scale_fill_brewer()

pie

# Wow. Now, let's say you've been stopped. Given that you're X race, 
# are you more or less likely to be arrested?

# create a legal action column and select only relevant columns
legalActiondf <- df %>% 
  mutate(legal_action_taken = Result_of_Stop == "Citation Issued" | Result_of_Stop == "Arrest") %>% 
  select(-1, -5, -7)

likelihood_to_be_arrested_given_race <- legalActiondf %>% 
  group_by(Driver_Race) %>% 
  summarize(percent_legal_action_taken = 100 * sum(legalAction == T)/n()) %>% 
  ungroup() %>% 
  arrange(desc(percent_legal_action_taken))

likelihood_to_be_arrested_given_race
pie2 <- df2 %>% 
  mutate(ethnicityArrestedPercent = ethnicityArrestedPercent) %>% 
  group_by(ethnicityArrestedPercent) 

pie2

# Given ethnicity, how likely are you to be stopped? Actually can't answer this! Coz we only see people who have already been stopped
```


```{r}
# Do officers have a biases towards stopping certain races?

# get a count of how many stops made, by ethnicity
dfStoppedRace <-  df %>% 
  group_by(Officer_Race) %>% 
  mutate(driver_stops_made = sum(n())) 

dfStoppedRace %>% 
  group_by(Officer_Race, Driver_Race) %>% 
  summarize(percent_race_stopped = 100 * n()/driver_stops_made[1]) %>% 
  ungroup() %>%
  group_by(Officer_Race) %>% 
  arrange(desc(percent_race_stopped), .by_group=T) %>% 
  View()

dfStoppedRace$driver_stops_made[2]

# What percent of stops of people actually lead to an arrest?
# 42


```

```{r}
# let's use decision trees!
library(rpart)
library(rpart.plot)

# 0. Clean table to remove columns that make up legal_action_taken
legalActionTreedf <- legalActiondf[c(-8)]

# 0.1 Change from boolean to string (factor) in order for prediction to work
legalActionTreedf %<>% 
  mutate(legal_action_taken = replace(legal_action_taken, legal_action_taken==T, "Legal Action Taken")) %>% 
           mutate(legal_action_taken = replace(legal_action_taken, legal_action_taken==F, "Not Taken"))


# 1. Begin with a small complexity parameter (0.0001)
set.seed(123)
treeLegal<- rpart(legal_action_taken ~ Officer_Race + Officer_Gender + Driver_Race + Driver_Age + Driver_Gender + Reason_for_Stop + Was_a_Search_Conducted, 
              data=legalActionTreedf, 
              control=rpart.control(cp=0.001)) # colnames(legalActiondf)

# 2. Pick tree size that minimizes misclassification
printcp(treeLegal)
bestcp <- treeLegal$cptable[which.min(treeLegal$cptable[,"xerror"]), "CP"]
bestcp

# 3. Prune tree using the best cp
treeLegal.pruned <- prune(treeLegal, cp = bestcp)
printcp(treeLegal)

# confusion matrix (training data)
treeLegal.pruned
conf.matrix <- table(legalActionTreedf$legal_action_taken, 
                     predict(tree.pruned.new, type="class"))

rownames(conf.matrix) <- paste("Actual", rownames(conf.matrix), sep=":")
colnames(conf.matrix) <- paste("Pred", colnames(conf.matrix), sep=":")
print(conf.matrix)

# plotting
tot_count <- function(x, labs, digits, varlen){
  paste(labs, "\n\nn =", x$frame$n)
}

prp(tree.pruned, faclen = 0, cex = 0.4, node.fun=tot_count)

# including colour
only_count <- function(x, labs, digits, varlen)
{
  paste(x$frame$n)
}

boxcols <- c("pink", "palegreen3")[tree.pruned$frame$yval]

par(xpd=TRUE)
prp(treeLegal.pruned, faclen = 0, cex = 0.8, node.fun=only_count, box.col = boxcols)
legend("bottomleft", legend = c("legal action taken", "not taken"), fill = c("pink", "palegreen3"))

###


```



